# 大型系统架构

## 高可用
冗余、健康监测、错误恢复
1. 负载均衡
2. 数据备份
3. 异地容灾
## 可伸缩
1. 开发框架
2. 多层设计
3. 业务分割
## 高性能
1. 高速缓存
2. 并行计算
3. 异地镜像

# 架构设计
1. 服务器集群、负载均衡
    1. DNS负载均衡
        优点：简单
        缺点：访问下线的服务器
        作用：CDN加速，访问最近服务器
    2. NAT
        网络地址跳转
    3. 反向代理负载均衡
        web前端：Nginx/HAProxy + Keepalived
        后端：数据库一主多从，读写分离LVS + Keepalived
        Nginx
            优点：web服务器、缓存、故障检测、静态文件服务器
            缺点：仅支持http\s,email协议、只针对端口检测、不支持session保持
        HAProxy
            解决Nginx的缺点，支持session,支持url检测服务器
2. 高可用性
    1. 负载均衡算法
        反映服务器的处理能力、网络状态
        1. 轮询均衡
        2. 权重轮询均衡
        3. 随机均衡
        4. 响应速度均衡
        5. 最少连接均衡
        6. 处理能力均衡
        7. DNS响应均衡
    2. 健康检查q
        1. Ping侦测
        2. TCP Open侦测
        3. HTTP URL
    3. Session复制与共享
        服务器集群会话统一
        cookie
        节点无状态化，可伸缩性
3. 缓存架构
    1. 浏览器缓存
        header
    2. 服务器本地缓存（不利于可伸缩)
    3. 反向代理服务器缓存
        Nginx, CDN缓存
    4. 数据缓存
        Redis集群：RDB\AOF
    5. 数据库缓存
        query cache: 以sql为key缓存结果
4. 数据库架构
    1. 单机处理
        1. sql优化
        2. 静动态资源分开
        3. 分表
        4. 内存索引
    2. 集群架构
        数据可靠性：冗余
        服务可用性
        方式
            1. Share-Disk
            2. Share-Nothing
            可负载均衡
            sql-server Moebius
                数据分布到多个节点，每个节点都能提供服务
    3. 拆分
        1. 垂直拆分
        2. 水平拆分
        3. 联合拆分
5. 存储架构
    磁盘阵列
        1. 提高读取速度等
    RAID
    热备份
    读写分离
    存储结构
        1. 封闭系统存储
        2. 开放系统存储
            1. 内置存储
            2. 外挂存储
                1. 直连式存储DAS
                2. 网络存储FAS
                    1. 网络接入存储NAS
                    2. 存储区域网络SAN
6. 消息队列
    以队列和发布订阅的异步传输方式
    RabbitMQ
        普通集群 + mirror queue
        可靠性要求高
    Kafka
        zookeeper管理broker、comsumer, producer注册Topic到ZK
        大数据量处理
    应用场景：
        1. 异步处理
        2. 应用解耦
        3. 流量销锋
        4. 日志处理
        5. 消息通讯
    中间件(高可用，持久化)
        1. 逻辑写入MQ,发送确认模式
        2. 发布订阅模式
        3. 消息最终一致性：MQ + DB
7. 非结构化存储 NoSQL
    适用：
        1. 数据模型简单
        2. 灵活的数据结构
        3. 性能要求高
        4. 不要求高度一致性
        5. key-value
    分类
        1. key-value: Redis
            内容缓存，大数据高访问负载
            优点：查找快，简单易部署
            缺点：数据无结构，字符串或二进制
        2. 列存储: Cassandra
            分布式文件系统
            优点：查找快，可容易进行分布式扩展
            缺点：功能先对局限
        3. 文档： MongoDb
            value结构化
            优点：数据结构灵活，不需要提前定义
            缺点：查找性能不高
        4. 图形：Neo4J
    Redis
        key-value形式
        string, list, hash, set, sort set
        RDB, AOF
        优点：性能高，持久化，支持pub/sub
        主从结构：master（关闭持久化），多slave（持久化，只读）
    MongoDB
        支持索引、游标，搜索功能强大，结构灵活，不支持事务，关系型数据库替代
        具备key-value高性能和高度伸缩，又结合RDBMS丰富的功能
        集群：
            1. 分片
            2. 副本
            3. 路由
            4. 配置服务
        缺点、局限：
            不支持事务、大磁盘、内存大、64位、多台机器
    Redis VS MongoDB
        Redis: 较小数据量
        mongodb：海量数据
        不适合：复杂sql和事务
8. 安全架构
    四大安全隐患
        1. 黑客:注入
        2. 网络流氓:DDOS
        3. 内部后台管理
        4. 硬件损坏
    措施
        1. 防止伪造输入
        2. 清晰定义授权
        3. 错误验证
        4. 加密算法
9. 监控、预警系统
10. 统一配置管理
11. 大型网站技术演变
    1. 物理分离应用、数据库
    2. 缓存改善性能
    3. 应用集群
    4. 数据库读写分离
    5. 反向代理和CDN加速
    6. 分布式文件系统和数据库
    7. 使用NoSQL和搜索引擎
    8. 业务和应用拆分
    9. 分布式微服务

# 微服务
